name: Calculate Code Coverage Percentage

on:
  pull_request:
    branches:
      - main

jobs:
  calculate-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Setup .NET
        uses: actions/setup-dotnet@v1

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release

      - name: Run tests with coverage
        run: dotnet test --configuration Release --no-restore --verbosity normal /p:CollectCoverage=true /p:CoverletOutputFormat=lcov /p:CoverletOutput=./lcov

      - name: Calculate coverage percentage
        run: |
          dotnet tool install -g dotnet-reportgenerator-globaltool
          reportgenerator "-reports:./lcov/**/*.xml" "-targetdir:coverage-report" "-reporttypes:HtmlInline_AzurePipelines"

      - name: Extract coverage percentage
        id: coverage
        run: |
          total=$(grep -oP '(?<=<line.*covered=")[0-9]+' coverage-report/Summary/index.htm | paste -sd+ - | bc)
          covered=$(grep -oP '(?<=<line.*total=")[0-9]+' coverage-report/Summary/index.htm | paste -sd+ - | bc)
          echo "Total lines: $total"
          echo "Covered lines: $covered"
          echo "::set-output name=coverage-percentage::$covered / $total * 100"

      - name: Display coverage percentage
        run: echo "Code coverage" ${{ steps.calculate-coverage.outputs.coverage-percentage }}
